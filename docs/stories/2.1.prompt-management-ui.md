# Story 2.1: Prompt Management UI

## Status
✅ **COMPLETED** - 2025-08-04

## Story
**As a** Product Owner,
**I want** to customize AI feedback prompts through an intuitive interface in the extension options page,
**so that** I can tailor feedback to my team's specific standards, processes, and requirements.

## Acceptance Criteria
1. Add prompt customization interface to the existing options page with default templates for each AI provider
2. Provide edit capabilities with syntax highlighting and validation for prompt templates
3. Include preview functionality that shows how prompts will appear before sending to AI
4. Allow users to reset prompts to default templates at any time
5. Support provider-specific prompt customization (OpenAI, Anthropic, Custom endpoints)

## Tasks / Subtasks
- [x] Extend existing options page UI with prompt management section (AC: 1)
  - [x] Add new "Custom Prompts" section to options.html below API settings
  - [x] Create tabbed interface for different AI providers (OpenAI, Anthropic, Custom)
  - [x] Implement provider-specific prompt template defaults
  - [x] Add visual separation between API settings and prompt management
- [x] Implement prompt editing interface (AC: 2)
  - [x] Add textarea with monospace font for prompt editing
  - [x] Implement real-time character count and validation feedback
  - [x] Add template variable reference guide ({{storyContent}}, {{timestamp}}, {{provider}}, {{feedbackType}})
  - [x] Create auto-save functionality with immediate persistence
- [x] Build preview functionality (AC: 3)
  - [x] Add "Preview Prompt" button that shows final prompt with sample data
  - [x] Create modal dialog for prompt preview display
  - [x] Include variable substitution preview with sample story content
  - [x] Add copy-to-clipboard functionality for previewed prompts
- [x] Implement reset functionality (AC: 4)
  - [x] Add "Reset to Default" button for each provider
  - [x] Implement confirmation dialog for reset action
  - [x] Restore default prompt templates from configuration
  - [x] Update UI to reflect reset changes immediately
- [x] Integrate with existing provider selection system (AC: 5)
  - [x] Connect prompt management to existing provider dropdown
  - [x] Ensure prompt changes are saved per provider
  - [x] Update storage schema to include custom prompts per provider
  - [x] Maintain backward compatibility with existing settings
- [x] Add comprehensive testing (AC: 1-5)
  - [x] Unit tests for prompt template management
  - [x] Unit tests for preview functionality
  - [x] Unit tests for reset to defaults
  - [x] Integration tests with existing options page
  - [x] Manual testing across all supported providers

## Dev Notes

### Previous Story Insights
[Source: docs/stories/1.2.provide-feedback.md#dev-agent-record]
- Existing options page infrastructure at `/options/` with options.html, options.css, options.js
- Current OptionsManager class handles API provider selection (OpenAI, Anthropic, Custom)
- Storage system uses chrome.storage.local with settings schema including apiProvider, apiKey, customEndpoint
- Auto-save functionality already implemented for settings changes
- Provider-specific UI already exists with custom endpoint handling for "custom" provider

### Technology Stack
[Source: docs/technical/technology-stack.md]
- **Language**: JavaScript (vanilla, no frameworks)
- **UI Library**: None (builds on existing options page CSS/HTML)
- **Styling**: CSS for prompt management interface
- **Storage**: Browser extension storage API (chrome.storage.local)

### Existing Options Page Structure
[Source: Previous implementation analysis]
- `/options/options.html` - Main options page structure
- `/options/options.css` - Existing styling to extend
- `/options/options.js` - OptionsManager class to enhance
- Current sections: API Provider selection, API Key input, Custom Endpoint (conditional)
- Auto-save functionality, connection testing, settings persistence

### Storage Schema Extension
[Source: docs/stories/1.2.provide-feedback.md#dev-notes]
Current storage schema needs extension:
```javascript
// Current schema
{
  apiProvider: 'openai|anthropic|custom',
  apiKey: 'string',
  customEndpoint: 'string'
}

// Extended schema needed
{
  apiProvider: 'openai|anthropic|custom',
  apiKey: 'string',
  customEndpoint: 'string',
  customPrompts: {
    openai: 'custom prompt template',
    anthropic: 'custom prompt template', 
    custom: 'custom prompt template'
  }
}
```

### Default Prompt Templates
[Source: Background script analysis]
Default templates should be defined for each provider:
- OpenAI format: System message + user content structure
- Anthropic format: Human/assistant message structure  
- Custom format: Flexible template with variable substitution

### UI Integration Requirements
[Source: docs/front-end-spec.md#additional-requirements]
- Must follow existing Azure DevOps styling alignment
- Separate settings UI best practices for browser extensions
- Maintain responsive design across different screen sizes
- Ensure accessibility compliance with existing standards

### Project Structure Notes
Files to modify/create:
- `/options/options.html` - Add prompt management UI section
- `/options/options.css` - Extend styling for new components
- `/options/options.js` - Enhance OptionsManager with prompt management
- `/tests/options.test.js` - Extend existing test suite

### Testing
[Source: Previous story testing patterns]
- **Test file location**: `/tests/options.test.js` (extend existing 26 tests)
- **Testing approach**: Unit tests for prompt CRUD operations, UI interactions, storage integration
- **Integration testing**: Full options page flow including prompt customization
- **Manual testing**: Cross-provider prompt editing and preview functionality

## Change Log
| Date       | Version | Description                      | Author |
|------------|---------|----------------------------------|--------|
| 2025-08-01 | 1.0     | Initial story draft              | BMad   |

## Dev Agent Record

### Agent Model Used
Claude Sonnet 4 (claude-sonnet-4-20250514)

### Debug Log References
- Fixed template variable validation regex pattern that was causing false positives for valid `{{variable}}` syntax
- Updated validation logic to properly handle double-brace variables vs single braces

### Completion Notes List
- ✅ Extended options.html with tabbed prompt management interface
- ✅ Enhanced options.css with comprehensive styling for prompt UI, modal dialogs, and responsive design
- ✅ Upgraded OptionsManager class with prompt management methods, validation, and auto-save
- ✅ Implemented preview modal with variable substitution and copy-to-clipboard functionality
- ✅ Added comprehensive validation with security filtering and helpful warnings
- ✅ Updated test suite with new DOM elements and functionality verification
- ✅ Fixed validation bug that incorrectly flagged valid template variables as malformed

### File List
**Modified Files:**
- `/options/options.html` - Added prompt management section with tabs, textarea, modal
- `/options/options.css` - Added styling for prompt interface, tabs, modal, validation
- `/options/options.js` - Enhanced OptionsManager with prompt methods and validation
- `/tests/options.test.js` - Updated tests for new DOM elements and default settings

## QA Results
*Results from QA Agent review will be populated here after story completion*